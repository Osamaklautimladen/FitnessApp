<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√úbung starten</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script id="exercises-data" type="application/json">
        {{ exercises | tojson | safe }}
    </script>
   
    <script>
          // Exercise configuration from backend
        const exerciseTime = {{ exercise_time }};
        const pauseTime = {{ pause_time }};
        
        let currentExerciseIndex = 0;
        let currentSet = 1;
        let currentRepetition = 1;
        let isRunning = false;
        let timer;

             // Parse exercises data
        let exercises = [];
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const exercisesData = document.getElementById('exercises-data');
                exercises = JSON.parse(exercisesData.textContent);
                console.log("Loaded exercises:", exercises);
                console.log(`Exercise time: ${exerciseTime}s, Pause time: ${pauseTime}s`);
                
                if (!exercises || exercises.length === 0) {
                    alert("Keine √úbungen ausgew√§hlt!");
                    window.location.href = "{{ url_for('index') }}";
                    return;
                }
                
                // Initialize the first exercise
                startExercise();
                
                // Display initial timer
                document.getElementById('timer').innerText = formatTime(exerciseTime);
                
            } catch (error) {
                console.error("Error loading exercise data:", error);
                alert("Fehler beim Laden der √úbungen!");
                window.location.href = "{{ url_for('index') }}";
            }
        });
        
        function startExercise() {
            const exercise = exercises[currentExerciseIndex];
            document.getElementById('exercise-title').innerText = exercise.title;
            document.getElementById('exercise-description').innerText = exercise.description;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            document.getElementById('exercise-progress').innerText = `√úbung ${currentExerciseIndex + 1} von ${exercises.length}`;
        
            let exerciseImage = document.createElement('img');
            exerciseImage.src = `/static/images/${exercise.image}`;
            exerciseImage.alt = exercise.title;
            exerciseImage.style.display = "block";
        
            let imageContainer = document.getElementById('exercise-image');
            imageContainer.innerHTML = "";
            imageContainer.appendChild(exerciseImage);
        
            if (!currentExerciseIndex == 0) {
                startTimer();
            }
        }


        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                let timeElapsed = exerciseTime;
                let audio = new Audio("/static/mp3/countdown10.mp3");
                timer = setInterval(() => {
                    document.getElementById('timer').innerText = formatTime(timeElapsed);
                    if (timeElapsed == 10) {
                        audio.play().then(() => console.log("Sound erlaubt!"))
                        .catch(error => console.error("Autoplay blockiert:", error));
                    }
                    
                    if (timeElapsed == 0) {
                        clearInterval(timer);
                        timeElapsed = 0;
                        isRunning = false;
                       
                        audio.pause();
                        audio.currentTime = 0;

                        if(exercises.length == 1){
                            alert("Alle √úbungen abgeschlossen!");
                            console.error(hi);
                            window.location.href = "{{ url_for('index') }}"; // Zur√ºck zur Startseite
                        } else {
                            console.error();
                            startPauseTimer();
                        }
                    }
                    console.error(timeElapsed);
                    timeElapsed--;
            }, 1000);

                document.getElementById('start-button').style.display = 'none';
                document.getElementById('stop-button').style.display = 'block';
            }
        }

        function stopTimer() {
            if (isRunning) {
                clearInterval(timer);
                isRunning = false;
                document.getElementById('stop-button').style.display = 'none';
                document.getElementById('start-button').style.display = 'block';
                currentRepetition++;
                updateRepetitionCircles();
                if (currentRepetition > exercises[currentExerciseIndex].repetitions) {
                    currentSet++;
                    currentRepetition = 1;
                    if (currentSet > exercises[currentExerciseIndex].sets) {
                        alert("Training abgeschlossen!");
                        window.location.href = "{{ url_for('index') }}"; // Zur√ºck zur Startseite
                    } else {
                        document.getElementById('next-exercise-button').style.display = 'block'; // Zeige den Button f√ºr die n√§chste √úbung an
                    }
                }
            }
        }
        
        function startPauseTimer() {
            console.log("Start startPauseTimer()");

            let pauseModalElement = document.getElementById('pauseModal');
            
            if (!pauseModalElement) {
                console.error("Error: #pauseModal not found in HTML!");
                return;
            }

            let pauseModal = new bootstrap.Modal(pauseModalElement, { keyboard: false });
            pauseModal.show();

            let pauseTimer = pauseTime;
            let pauseTimerElement = document.getElementById('pause-timer');
            let audio = new Audio("/static/mp3/countdown10.mp3");

            let pauseInterval = setInterval(() => {
                pauseTimer--;
                pauseTimerElement.innerText = pauseTimer;
                if (pauseTimer == 10) {
                    audio.play().catch(error => console.error("Error: Autoplay ist blockiert", error));
                }
                if (pauseTimer <= 0) {
                    clearInterval(pauseInterval);
                    audio.pause();
                    audio.currentTime = 0;
                    pauseModal.hide(); 
                    console.log("Pop-up closed. Next training...");
                    startNextExercise();
                    
                }
            }, 1000);
        }

    
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function updateRepetitionCircles() {
            const exercise = exercises[currentExerciseIndex];
            const circlesContainer = document.getElementById('repetition-circles');
            circlesContainer.innerHTML = '';

            for (let i = 1; i <= exercise.repetitions; i++) {
                const circle = document.createElement('span');
                circle.className = 'circle';
                if (i <= currentRepetition) {
                    circle.classList.add('filled');
                }
                circlesContainer.appendChild(circle);
            }
        }

        function cancelExercise() {
            clearInterval(timer);
            isRunning = false;
            window.location.href = "{{ url_for('level', level='mittel') }}"; // Zur√ºck zur √úbungs√ºbersicht
        }

        function startNextExercise() {
            currentExerciseIndex++;
            console.error(currentExerciseIndex+"currentExerciseIndex");
            if (currentExerciseIndex < exercises.length) {
                currentSet = 1;
                console.error(exercises.length+"exercises.length");
                currentRepetition = 1;
                document.getElementById('next-exercise-button').style.display = 'none'; // Verstecke den Button
                startExercise(); // Starte die n√§chste √úbung
            } else {
                alert("Alle √úbungen abgeschlossen!");
                window.location.href = "{{ url_for('index') }}"; // Zur√ºck zur Startseite
            }
        }

        window.onload = function() {
            document.getElementById('timer').innerText = formatTime(exerciseTime);
            startExercise();
        };
    </script>
     <style>
        /* üìå –û–±—â–∏–π —Å—Ç–∏–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        body {
            background-color: #f5f5f5;
            font-family: 'Roboto', sans-serif;
        }

        /* üìå –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è */
        .exercise-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            margin: 20px auto;
        }

        /* üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è */
        .exercise-image img {
            width: 100%;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* ‚è≥ –¢–∞–π–º–µ—Ä */
        .timer-container {
            font-size: 3rem;
            font-weight: bold;
            color: #424242;
            background: #e0e0e0;
            border-radius: 10px;
            display: inline-block;
            padding: 10px 20px;
            margin-top: 15px;
        }

        /* üîò –ö–Ω–æ–ø–∫–∏ */
        .btn {
            border-radius: 25px;
            font-size: 1.2rem;
            padding: 12px 20px;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .exercise_description{
            margin-bottom: 10px;
        }

        p {
            margin-top: 0;
            margin-bottom: 4px;
        }

        /* üì± –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .exercise-container {
                padding: 15px;
            }
            .timer-container {
                font-size: 2.5rem;
            }
            .btn {
                font-size: 1rem;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="exercise-container">
        <h1 id="exercise-title" class="text-center"></h1>
        <p id="exercise-progress" class="text-center text-muted"></p>
        <div  class="exercise_description" id="exercise-description" class="text-center"></div>
        <div class="exercise-image" id="exercise-image"></div>
        <div class="timer-container" id="timer">0:{{exerciseTime}}</div>

        <div class="d-grid gap-3 mt-4">
            <button id="start-button" class="btn btn-success" onclick="startTimer()">Start</button>
            <button id="stop-button" class="btn btn-warning" style="display: none;" onclick="stopTimer()">Stop</button>
            <button id="cancel-button" class="btn btn-danger" onclick="cancelExercise()">Abbrechen</button>
            <button id="next-exercise-button" class="btn btn-primary" style="display: none;" onclick="startNextExercise()">N√§chste √úbung starten</button>
        </div>
    </div>

    <div class="modal fade" id="pauseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kurze Pause</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <h2 id="pause-timer">{{pauseTime}}</h2>
                    <p>Bereite dich auf die n√§chste √úbung vor...</p>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
